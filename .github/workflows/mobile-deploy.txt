name: Trigger Codemagic Build

on:
  workflow_dispatch: # Only allow manual triggering
    inputs:
      environment:
        description: 'Build environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      custom_message:
        description: 'Custom message for the build'
        required: false
        default: 'Manual build triggered'

jobs:
  trigger-build:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Codemagic Build
        run: |
          curl -X POST \
          -H "Content-Type: application/json" \
          -H "x-auth-token: ${{ secrets.CODEMAGIC_API_TOKEN }}" \
          -d '{
            "appId": "${{ secrets.CODEMAGIC_APP_ID }}",
            "workflowId": "my-workflow",
            "branch": "main",
            "environment": {
              "variables": {
                "CUSTOM_MESSAGE": "${{ github.event.inputs.custom_message || 'Manual build triggered' }}",
                "BUILD_ENV": "${{ github.event.inputs.environment }}"
              }
            }
          }' \
          https://api.codemagic.io/builds
