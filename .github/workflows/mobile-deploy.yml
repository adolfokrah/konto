name: Trigger Codemagic Build

on:
  workflow_run:
    workflows: ["Mobile Integration Tests"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch: # Keep manual triggering option
    inputs:
      environment:
        description: 'Build environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      custom_message:
        description: 'Custom message for the build'
        required: false
        default: 'Manual build triggered'

jobs:
  trigger-build:
    runs-on: ubuntu-latest
    # Only run if the mobile integration tests passed
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Trigger Codemagic Build
        run: |
          curl -X POST \
          -H "Content-Type: application/json" \
          -H "x-auth-token: ${{ secrets.CODEMAGIC_API_TOKEN }}" \
          -d '{
            "appId": "${{ secrets.CODEMAGIC_APP_ID }}",
            "workflowId": "my-workflow",
            "branch": "main",
            "environment": {
              "variables": {
                "CUSTOM_MESSAGE": "${{ github.event.inputs.custom_message || 'Build triggered after successful integration tests' }}",
                "BUILD_ENV": "${{ github.event.inputs.environment || 'staging' }}"
              }
            }
          }' \
          https://api.codemagic.io/builds
