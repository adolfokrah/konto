name: Mobile Build Pipeline

on:
  workflow_run:
    workflows: ["Mobile Integration Tests"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch: # Keep manual triggering option
    inputs:
      environment:
        description: 'Build environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
        - both
      custom_message:
        description: 'Custom message for the build'
        required: false
        default: 'Manual build triggered'

jobs:
  staging-build:
    name: Staging Build
    runs-on: ubuntu-latest
    # Only run if the mobile integration tests passed OR manual trigger
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    # Skip staging if manual trigger requests production only
    continue-on-error: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Trigger Staging Build
        uses: ./.github/actions/trigger-codemagic-build
        with:
          codemagic-api-token: ${{ secrets.CODEMAGIC_API_TOKEN }}
          codemagic-app-id: ${{ secrets.CODEMAGIC_APP_ID }}
          workflow-id: 'staging-workflow'
          environment: 'staging'
          custom-message: ${{ github.event.inputs.custom_message || 'Staging build triggered after successful integration tests' }}
          branch: 'main'

  production-approval:
    name: Production Approval
    runs-on: ubuntu-latest
    needs: staging-build
    environment: production
    steps:
      - name: Approve production deployment
        run: echo "Production deployment approved"

  production-build:
    name: Production Build
    runs-on: ubuntu-latest
    needs: [staging-build, production-approval]
    # Only run production if both staging and approval succeed
    if: ${{ success() && (github.event.inputs.environment == 'production' || github.event.inputs.environment == 'both' || github.event_name == 'workflow_run') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Trigger Production Build
        uses: ./.github/actions/trigger-codemagic-build
        with:
          codemagic-api-token: ${{ secrets.CODEMAGIC_API_TOKEN }}
          codemagic-app-id: ${{ secrets.CODEMAGIC_APP_ID }}
          workflow-id: 'production-workflow'
          environment: 'production'
          custom-message: ${{ github.event.inputs.custom_message || 'Production build triggered after successful staging build' }}
          branch: 'main'
         
